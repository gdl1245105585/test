`begin_keywords "1800-2017"
`line 1 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 1
 
 
 

`line 5 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
 
 

`line 8 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
 
`line 8 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
`line 1 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 1
 
`line 3 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0

`line 3 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
 
 
 
 
 
 
 
 

`line 13 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
 

`line 16 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
 
















`line 34 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
 


`line 38 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
 







`line 47 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 














`line 62 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 















`line 78 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 








`line 87 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 













`line 101 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 











`line 113 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 











`line 125 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 















`line 141 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
















`line 158 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 









`line 168 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 














`line 183 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 















`line 199 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 
















`line 216 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 0
 






`line 223 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/registers.svh" 2
`line 8 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0

`line 9 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
 
`line 9 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
`line 1 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 1
 
`line 2 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
 

`line 5 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
 
 

`line 9 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
 

`line 12 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
  
   
     
     
       
       
    
  







`line 28 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
 
 
 
   




`line 37 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 


`line 40 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 












`line 53 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
 



`line 58 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 








`line 67 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 












`line 80 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 











`line 92 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 












`line 105 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 









`line 115 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 





`line 121 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 









`line 131 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 






`line 138 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 






`line 145 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 










`line 156 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 








`line 165 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 
















`line 182 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 






`line 189 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 






`line 196 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
 




`line 201 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 0
  

`line 203 "/repo/hw/system/snitch_cluster/.bender/git/checkouts/common_cells-f9d1cdce7573d0e2/include/common_cells/assertions.svh" 2
`line 9 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0


`line 11 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
 
module snitch_icache_l0 import snitch_icache_pkg::*; #(
    parameter config_t CFG = '0,
    parameter int unsigned L0_ID = 0
) (
    input  logic clk_i,
    input  logic rst_ni,
    input  logic flush_valid_i,

`line 20 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    input  logic                      enable_prefetching_i,
    output icache_events_t            icache_events_o,

`line 23 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    input  logic [CFG.FETCH_AW-1:0]   in_addr_i,
    input  logic                      in_valid_i,
    output logic [CFG.FETCH_DW-1:0]   in_data_o,
    output logic                      in_ready_o,
    output logic                      in_error_o,

`line 29 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    output logic [CFG.FETCH_AW-1:0]      out_req_addr_o,
    output logic [CFG.ID_WIDTH_REQ-1:0]  out_req_id_o,
    output logic                         out_req_valid_o,
    input  logic                         out_req_ready_i,

`line 34 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    input  logic [CFG.LINE_WIDTH-1:0]    out_rsp_data_i,
    input  logic                         out_rsp_error_i,
    input  logic [CFG.ID_WIDTH_RESP-1:0] out_rsp_id_i,
    input  logic                         out_rsp_valid_i,
    output logic                         out_rsp_ready_o
);

`line 41 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  typedef logic [CFG.FETCH_AW-1:0] addr_t;
  typedef struct packed {
    logic [CFG.L0_TAG_WIDTH-1:0] tag;
    logic                        vld;
  } tag_t;

`line 47 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic [CFG.L0_TAG_WIDTH-1:0] addr_tag, addr_tag_prefetch;

`line 49 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  tag_t [CFG.L0_LINE_COUNT-1:0] tag;
  logic [CFG.L0_LINE_COUNT-1:0][CFG.LINE_WIDTH-1:0] data;

`line 52 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic [CFG.L0_LINE_COUNT-1:0] hit, hit_early, hit_prefetch;
  logic hit_early_is_onehot;
  logic hit_any;
  logic hit_prefetch_any;
  logic miss;

`line 58 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic [CFG.L0_LINE_COUNT-1:0] evict_strb;
  logic [CFG.L0_LINE_COUNT-1:0] flush_strb;
  logic [CFG.L0_LINE_COUNT-1:0] validate_strb;

`line 62 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  typedef struct packed {
    logic vld;
    logic [CFG.FETCH_AW-1:0] addr;
  } prefetch_req_t;

`line 67 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic latch_prefetch, last_cycle_was_prefetch_q;
  prefetch_req_t prefetcher_out;
   
   
   
  logic prefetch_req_vld_q, prefetch_req_vld_d;
  logic [CFG.FETCH_AW-1:0] prefetch_req_addr_q, prefetch_req_addr_d;

`line 75 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  logic [CFG.L0_LINE_COUNT-1:0] pending_line_refill_q;
  logic pending_refill_q, pending_refill_d;

`line 79 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic evict_req;
  logic last_cycle_was_miss_q;

`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge ( clk_i) or negedge ( rst_ni)) begin                           
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    if (! rst_ni) begin                                                             
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      last_cycle_was_miss_q <= ('0);                                                        
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end else begin                                                                   
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      last_cycle_was_miss_q <= (miss);                                                                  
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end                                                                              
`line 82 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end
  
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge ( clk_i) or negedge ( rst_ni)) begin                           
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    if (! rst_ni) begin                                                             
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      last_cycle_was_prefetch_q <= ('0);                                                        
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end else begin                                                                   
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      last_cycle_was_prefetch_q <= (latch_prefetch);                                                                  
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end                                                                              
`line 83 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end

`line 85 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic evict_because_miss, evict_because_prefetch;

`line 87 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  typedef struct packed {
    logic                    is_prefetch;
    logic [CFG.FETCH_AW-1:0] addr;
  } req_t;

`line 92 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  req_t refill, prefetch;
  logic refill_valid, prefetch_valid;
  logic refill_ready, prefetch_ready;
  req_t out_req;

`line 97 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign evict_because_miss = miss & ~last_cycle_was_miss_q;
  assign evict_because_prefetch = latch_prefetch & ~last_cycle_was_prefetch_q;

`line 100 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign evict_req = evict_because_miss | evict_because_prefetch;

`line 102 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign addr_tag = in_addr_i >> CFG.LINE_ALIGN;

`line 104 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
  for (genvar i = 0; i < CFG.L0_LINE_COUNT; i++) begin : gen_cmp_fetch
    assign hit_early[i] = tag[i].vld &
      (tag[i].tag[CFG.L0_EARLY_TAG_WIDTH-1:0] == addr_tag[CFG.L0_EARLY_TAG_WIDTH-1:0]);
     
    if (CFG.L0_TAG_WIDTH == CFG.L0_EARLY_TAG_WIDTH) begin : gen_hit_assign
      assign hit[i] = hit_early[i];
     
    end else begin : gen_hit
      assign hit[i] = hit_early[i] &
        (tag[i].tag[CFG.L0_TAG_WIDTH-1:CFG.L0_EARLY_TAG_WIDTH]
          == addr_tag[CFG.L0_TAG_WIDTH-1:CFG.L0_EARLY_TAG_WIDTH]);
    end
    assign hit_prefetch[i] = tag[i].vld & (tag[i].tag == addr_tag_prefetch);
  end

`line 122 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign hit_any = |hit;
  assign hit_prefetch_any = |hit_prefetch;
  assign miss = ~hit_any & in_valid_i & ~pending_refill_q;

`line 126 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  for (genvar i = 0; i < CFG.L0_LINE_COUNT; i++) begin : gen_array
     
    always_ff @(posedge clk_i or negedge rst_ni) begin
      if (!rst_ni) begin
        tag[i].vld <= 0;
        tag[i].tag <= 0;
      end else begin
        if (evict_strb[i]) begin
          tag[i].vld <= 1'b0;
          tag[i].tag <= evict_because_prefetch ? addr_tag_prefetch : addr_tag;
        end else if (validate_strb[i]) begin
          tag[i].vld <= 1'b1;
        end
        if (flush_strb[i]) begin
          tag[i].vld <= 1'b0;
        end
      end
    end
    if (CFG.EARLY_LATCH) begin : gen_latch
       
      always_latch begin
        if (clk_i && validate_strb[i]) begin
          data[i] <= out_rsp_data_i;
        end
      end
    end else begin : gen_ff
      
`line 152 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge (clk_i)) begin   
`line 152 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    data[i] <= (validate_strb[i]) ? (out_rsp_data_i) : (data[i]);   
`line 152 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end
    end
  end

`line 156 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
   
  assign in_ready_o = hit_any;

`line 162 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic [CFG.LINE_WIDTH-1:0] ins_data;
  always_comb begin : data_muxer
    ins_data = '0;
    for (int unsigned i = 0; i < CFG.L0_LINE_COUNT; i++) begin
      ins_data |= {CFG.LINE_WIDTH{hit[i]}} & data[i];
    end
    in_data_o = ins_data >> (in_addr_i[CFG.LINE_ALIGN-1:CFG.FETCH_ALIGN] * CFG.FETCH_DW);
  end

`line 171 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
  if (CFG.L0_TAG_WIDTH != CFG.L0_EARLY_TAG_WIDTH) begin : gen_multihit_detection
    cc_onehot #(
      .Width (CFG.L0_LINE_COUNT)
    ) i_onehot_hit_early (
      .d_i (hit_early),
      .is_onehot_o (hit_early_is_onehot)
    );
  end else begin : gen_no_multihit_detection
    assign hit_early_is_onehot = 1'b1;
  end

`line 184 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
  logic [$clog2(CFG.L0_LINE_COUNT)-1:0] cnt_d, cnt_q;

`line 189 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_comb begin : evictor
    evict_strb = '0;
    cnt_d = cnt_q;

`line 193 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
     
    if (evict_req) begin
      evict_strb = 1 << cnt_q;
      cnt_d = cnt_q + 1;
      if (evict_strb == hit_early) begin
        evict_strb = 1 << cnt_d;
        cnt_d = cnt_q + 2;
      end
    end
  end

`line 204 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_comb begin : flush
    flush_strb = '0;
     
     
    if (hit_any && !hit_early_is_onehot) begin
       
       
      flush_strb = ~hit & hit_early;
    end
    if (flush_valid_i) flush_strb = '1;
  end

`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge ( clk_i) or negedge ( rst_ni)) begin                           
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    if (! rst_ni) begin                                                             
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      cnt_q <= ('0);                                                        
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end else begin                                                                   
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      cnt_q <= (cnt_d);                                                                  
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end                                                                              
`line 216 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end

`line 218 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
  assign refill.addr = addr_tag << CFG.LINE_ALIGN;
  assign refill.is_prefetch = 1'b0;
  assign refill_valid = miss;

`line 225 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 225 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge (clk_i)) begin   
`line 225 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    pending_line_refill_q <= (evict_req) ? (evict_strb) : (pending_line_refill_q);   
`line 225 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end
  
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge ( clk_i) or negedge ( rst_ni)) begin                           
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    if (! rst_ni) begin                                                             
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      pending_refill_q <= ('0);                                                        
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end else begin                                                                   
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      pending_refill_q <= (pending_refill_d);                                                                  
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end                                                                              
`line 226 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end

`line 228 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_comb begin
    pending_refill_d = pending_refill_q;
     
    if (pending_refill_q) begin
      if (out_rsp_valid_i & out_rsp_ready_o) begin
        pending_refill_d = 1'b0;
      end
     
    end else begin
      if (refill_valid && refill_ready) begin
        pending_refill_d = 1'b1;
      end
      if (latch_prefetch) begin
        pending_refill_d = 1'b1;
      end
    end
  end

`line 246 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign validate_strb = out_rsp_valid_i ? pending_line_refill_q : '0;
  assign out_rsp_ready_o = 1'b1;

`line 249 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign in_error_o = '0;

`line 251 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign out_req_addr_o = out_req.addr;
  assign out_req_id_o = {L0_ID, out_req.is_prefetch};

`line 254 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  always_comb begin
    out_req = prefetch;
    out_req_valid_o = prefetch_valid;
    prefetch_ready = out_req_ready_i;
    refill_ready = 1'b0;

`line 261 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    if (refill_valid) begin
      out_req_valid_o = refill_valid;
      out_req = refill;
      refill_ready = out_req_ready_i;
      prefetch_ready = 1'b0;
    end
  end

`line 269 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
   
   
  assign prefetcher_out.vld = enable_prefetching_i &
                              hit_any & ~hit_prefetch_any &
                              hit_early_is_onehot & ~pending_refill_q;

`line 278 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  localparam int unsigned FetchPkts = CFG.LINE_WIDTH/32;
  logic [FetchPkts-1:0] is_branch_taken;
  logic [FetchPkts-1:0] is_jal;
  logic [FetchPkts-1:0] mask;
   
  assign mask = '1 << in_addr_i[CFG.LINE_ALIGN-1:2];

`line 285 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  for (genvar i = 0; i < FetchPkts; i++) begin : gen_pre_decode
     
    always_comb begin
      is_branch_taken[i] = 1'b0;
      is_jal[i] = 1'b0;
      unique casez (ins_data[i*32+:32])
         
        riscv_instr::BEQ,
        riscv_instr::BNE,
        riscv_instr::BLT,
        riscv_instr::BGE,
        riscv_instr::BLTU,
        riscv_instr::BGEU: begin
           
           
           
          is_branch_taken[i] = ins_data[i*32+31];
        end
        riscv_instr::JAL: begin
          is_jal[i] = 1'b1;
        end
         
         
        default:;
      endcase
    end
  end

`line 314 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  logic [$clog2(FetchPkts)-1:0] taken_idx;
  logic no_prefetch;
  logic [$clog2(CFG.LINE_WIDTH)-1:0] ins_idx;
  assign ins_idx = 32*taken_idx;
   
  lzc #(
    .WIDTH(FetchPkts),
    .MODE(0)
  ) i_lzc_branch (
     
    .in_i (mask & (is_branch_taken | is_jal)),
    .cnt_o (taken_idx),
    .empty_o (no_prefetch)
  );

`line 329 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  addr_t base_addr, offset, uj_imm, sb_imm;
  logic [CFG.LINE_ALIGN-1:0] base_offset;
  assign base_offset = taken_idx << 2;
  assign uj_imm =
    $signed({ins_data[ins_idx+31], ins_data[ins_idx+12+:8],
             ins_data[ins_idx+20], ins_data[ins_idx+21+:10], 1'b0});
  assign sb_imm =
    $signed({ins_data[ins_idx+31], ins_data[ins_idx+7],
             ins_data[ins_idx+25+:6], ins_data[ins_idx+8+:4], 1'b0});

`line 339 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  always_comb begin
     
    base_addr = no_prefetch ? in_addr_i : {in_addr_i >> CFG.LINE_ALIGN, base_offset};
    offset = (1 << CFG.LINE_ALIGN);
     
    unique case ({is_branch_taken[taken_idx] & ~no_prefetch, is_jal[taken_idx] & ~no_prefetch})
       
      2'b01: offset = uj_imm;
       
      2'b10: offset = sb_imm;
      default:;
    endcase
  end

`line 354 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign prefetcher_out.addr = ($signed(base_addr) + offset) >> CFG.LINE_ALIGN << CFG.LINE_ALIGN;

`line 356 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  assign addr_tag_prefetch = prefetcher_out.addr >> CFG.LINE_ALIGN;

`line 359 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign latch_prefetch = prefetcher_out.vld & ~prefetch_req_vld_q;

`line 361 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_comb begin
      prefetch_req_vld_d = prefetch_req_vld_q;
      prefetch_req_addr_d = prefetch_req_addr_q;

`line 365 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      if (prefetch_ready) prefetch_req_vld_d = 1'b0;

`line 367 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      if (latch_prefetch) begin
          prefetch_req_vld_d = 1'b1;
          prefetch_req_addr_d = prefetcher_out.addr;
      end
  end

`line 373 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  assign prefetch.is_prefetch = 1'b1;
  assign prefetch.addr = prefetch_req_addr_q;
  assign prefetch_valid = prefetch_req_vld_q;

`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge ( clk_i) or negedge ( rst_ni)) begin                           
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    if (! rst_ni) begin                                                             
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      prefetch_req_vld_q <= ('0);                                                        
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end else begin                                                                   
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
      prefetch_req_vld_q <= (prefetch_req_vld_d);                                                                  
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    end                                                                              
`line 377 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end
  
`line 378 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  always_ff @(posedge (clk_i)) begin 
`line 378 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
    prefetch_req_addr_q <= (prefetch_req_addr_d);                    
`line 378 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  end

`line 380 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
  always_comb begin
    icache_events_o = '0;
    icache_events_o.l0_miss = miss;
    icache_events_o.l0_hit = hit_any & in_valid_i;
    icache_events_o.l0_prefetch = prefetcher_out.vld;
    icache_events_o.l0_double_hit = hit_any & ~hit_early_is_onehot & in_valid_i;
    icache_events_o.l0_stall = !in_ready_o & in_valid_i;
  end

`line 392 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
   
   
  
`line 395 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 395 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                     
`line 395 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 395 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 395 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      

`line 396 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  
`line 397 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 397 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                      
`line 397 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 397 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 397 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      

`line 398 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  
`line 399 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 399 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                         
`line 399 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 399 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 399 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      

`line 400 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 400 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 400 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                         
`line 400 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 400 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 400 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      


`line 402 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 402 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 402 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                         
`line 402 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 402 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 402 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      

`line 403 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  

`line 404 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 404 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                           
`line 404 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 404 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 404 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      


`line 406 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  
`line 406 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 406 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                         
`line 406 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 406 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 406 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      

`line 407 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
  

`line 409 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0

`line 409 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                         
`line 409 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                    
`line 409 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                
`line 409 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                     
`line 409 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                                      

`line 410 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
   
  
`line 411 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                                                                        
`line 411 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
                      


`line 413 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 0
endmodule

`line 415 "/repo/hw/ip/snitch_icache/src/snitch_icache_l0.sv" 2
